syntax = "proto3";

package coop.drivers.dispatch.v1beta1;

option go_package = "github.com/kevinmichaelchen/api-dispatch/internal/idl/coop/drivers/dispatch/v1beta1";

import "coop/drivers/dispatch/v1beta1/latlng.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";

service DispatchService {
  // Bulk-ingest driver locations.
  rpc UpdateDriverLocations(UpdateDriverLocationsRequest) returns (UpdateDriverLocationsResponse) {}

  // Bulk-ingest (on-demand or scheduled) trips.
  rpc CreateTrips(CreateTripsRequest) returns (CreateTripsResponse) {}

  // Gets the nearest drivers to a given trip pickup location.
  rpc GetNearestDrivers(GetNearestDriversRequest) returns (GetNearestDriversResponse) {}

  // Gets the nearest trips to a given driver's location.
  rpc GetNearestTrips(GetNearestTripsRequest) returns (GetNearestTripsResponse) {}
}

message DriverLocation {
  string driver_id = 1;
  google.protobuf.Timestamp timestamp = 2;
  LatLng lat_lng = 3;
}

message UpdateDriverLocationsRequest {
  repeated DriverLocation locations = 1;
}

message UpdateDriverLocationsResponse {}

message CreateTripsRequest {
  repeated Trip trips = 1;
}

message Trip {
  // where
  LatLng pickup_location = 1;
  // when
  google.protobuf.Timestamp scheduled_for = 2;
  // how much $$$
  double expected_payment = 3;
}

message CreateTripsResponse {}

message GetNearestDriversRequest {
  // trip pickup location
  LatLng pickup_location = 1;
  int32 limit = 2;
}

message GetNearestDriversResponse {
  repeated NearestDriversSearchResult results = 1;
  string pickup_address = 2;
}

message NearestDriversSearchResult {
  // Driver's ID
  string driver_id = 1;
  SearchResult search_result = 2;
}

message GetNearestTripsRequest {
  oneof driver {
    string driver_id = 1;
    LatLng driver_location = 2;
  }
  int32 limit = 3;
}

message GetNearestTripsResponse {
  repeated NearestTripsSearchResult results = 1;
}

message NearestTripsSearchResult {
  // Trip's ID
  string trip_id = 1;
  SearchResult search_result = 2;
}

message SearchResult {
  // Driver's distance from the pickup location (in meters)
  double distance_meters = 1;
  // Time it takes driver to go to pickup
  google.protobuf.Duration duration = 2;
  // The match's location.
  LatLng location = 3;
  // Human-readable location
  string address = 4;
  // The highest (finest) H3 resolution in which the match was found.
  int32 resolution = 5;
  // The k-value of the lowest k-ring (most immediate neighborhood) in which the
  // match was found.
  int32 k_value = 6;
}